# 로그정규 분포 기반 일일 자산 임의 갱신

Date: 2025-08-09
Status: 적용 중

<br/>

## 맥락

유저 자산 갱신 api인, `/msa/extension/api/update-asset/{userId}`에서 제공하는 기능은  
**실제 자금 이동이 없는 임시 시뮬레이션 API**로서, 사용자 자산을 하루 1회 임의 비율로 갱신해 반환하는 용도입니다.  
아래와 같은 요구 사항이 있습니다.

- 하루 기준으로 **유저별 독립**적으로 변동합니다.
- 같은 날에는 **여러 번 호출해도 동일한 결과**가 나옵니다.
- **재현성, 보안은 우선순위가 낮으며**, 서버 재시작이나 인스턴스가 달라도 무관합니다.
- **원금은 0 허용, 음수는 금지**합니다.
- 인프라는 단순화를 위해 **Redis 미사용**, **로컬 메모리 캐시**를 우선합니다.
- 현실감 반영을 위해 단순 균등·정규분포보다 **자산 수익률**에 자연스러운 곱셈형 분포인 **로그정규 분포**를 채택합니다.

<br/>
<br/>

## 결정

① **변동 모델: 로그정규(Log-normal) 수익률**

- 수익률 배수 $M$을 다음과 같이 정의합니다.

  $M = e^{\mu + \sigma Z}, \quad Z \sim \mathcal{N}(0,1)$

- 기대값 보정: $\mathbb{E}[M] = 1$이 되도록 $\mu = -\frac{1}{2}\sigma^2$로 설정합니다.
- 현실적 이상치 방지를 위해 최종 배수에 **클램프**를 적용합니다.

  $M \in [1+\text{min\%},\; 1+\text{max\%}]$

- 기본값: $\sigma = 0.02$ (약 2%), **클램프: −5% \~ +5%**

② **캐싱 전략: Caffeine 로컬 캐시로 ‘하루 1회’ 보장**

- 캐시 키: `userId|YYYY-MM-DD` (타임존: `Asia/Seoul`)
- 값: \*\*배수(multiplier)\*\*를 캐싱하여, 당일 원금이 변해도 일관된 결과를 보장합니다.
- 만료: `expireAfterWrite = 1일`, `maximumSize`는 DAU에 맞춰 조정(예: 300,000)
- 통계: 필요 시 `recordStats=true`로 히트율 관찰

③ **입력/설정 가드**

- 원금 검증: `asset >= 0` (0 허용, 음수 금지)
- 설정 검증: `sigma >= 0`, `minPercent <= maxPercent`를 기동 시 `@PostConstruct`에서 **fail-fast**

④ **환경 설정 바인딩**

- `application.yml` → `@ConfigurationProperties(asset.*)`로 바인딩
- 기본값을 코드/설정에 제공하여 로컬 실행 및 설정 실수 시 안전한 폴백 제공

⑤ **API 설계(요약)**

- `POST /msa/ext/api/update-asset/{userId}`
- Request: `{ asset: number }` (0 이상)
- Response: `{ userId, originalAsset, multiplier, updatedAsset, date }`

<br/><br/>

## 결과

- **유저별 독립**, **당일 일관성**, **현실적인 변동**을 단순 인프라로 구현했습니다.
- 성능: 호출당 난수 2개 + 로그/지수 연산 + 사칙연산만 수행하며, 캐시 히트 시 부하가 매우 적습니다.
- 운영: DAU 기반 `maximumSize`와 `expireAfterWrite`로 메모리 위생을 유지하며, 설정/입력 가드로 기동·런타임 안정성을 확보했습니다.

<br/>

| 운영 지침 항목 | 내용                                                                                                                     |
| -------------- | ------------------------------------------------------------------------------------------------------------------------ |
| 기본 파라미터  | `sigma=0.02`, `clamp=[-5,+5]%`, `expireAfterWriteDays=1`, `maximumSize=DAU×(1.2~2.0)`                                    |
| 모니터링       | multiplier 변동률(%) 분포, 캐시 hit/miss                                                                                 |
| 주의           | 재시작/멀티 인스턴스 시 캐시는 로컬이므로 일관성 보장 안 함(요구사항상 허용). 필요 시 Redis 또는 결정론적 시드 확장 가능 |

<br/><br/>

#### 향후 계획

- 도메인/애플리케이션/인프라 분리(포트·어댑터 구조)로 오케스트레이션 슬림화
- 시장 요인×개별 요인 하이브리드 모델 도입(현실감 강화)
- 배치 전환: “하루 1회 대량 갱신” 유스케이스로 분리 및 리포팅/히스토리 적재
- Redis 전환 또는 결정론 시드 도입으로 서버 간 일관성 강화 옵션 제공
