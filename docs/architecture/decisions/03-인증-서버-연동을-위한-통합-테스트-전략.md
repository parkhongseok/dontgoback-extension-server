# 인증 서버 연동을 위한 통합 테스트 전략

Date: 2025-08-05  
Status: Accepted

<br/>

## 맥락

확장 서버가 인증 서버로부터 발급받은 JWT를 **공개키 기반으로 검증하는 역할**을 수행할 때,  
단순한 단위 테스트만으로는, 다음과 같은 실제 운영 환경의 흐름을 충분히 검증하기 어렵습니다:

- 인증 서버와의 통신을 통해 **공개키를 받아오는 과정**
- 테스트용 클라이언트 자격 증명으로 **실제 JWT를 발급받는 과정**
- 메모리에 저장된 공개키를 이용해 **JWT 유효성을 검증하는 과정**

따라서, 위 전체 과정을 하나의 흐름으로 검증할 수 있는 **통합 테스트 구성**이 필요했습니다.

<br/>
<br/>

## 결정

### ① 실제 인증 서버 연동 테스트 구성

- 테스트 클래스: `InterServerAuthTest`

- 어노테이션:

  - `@SpringBootTest`로 실제 빈 로딩
  - `@TestInstance(PER_CLASS)`로 토큰을 한 번만 발급

- 테스트 구성 요소:
  - `InterServerKeyTokenTestProvider`: 인증 서버와의 통신 담당
  - `InterServerJwtVerifier`: 공개키 기반의 JWT 파싱 및 검증 담당

<br/>

### ② 테스트 흐름 구성

- `@BeforeAll`: 인증 서버에 요청하여 테스트용 JWT를 1회 발급받고, 필드에 저장
- `공개키_로딩_성공_테스트`: 인증 서버에서 공개키를 받아와 메모리에 적재되는지 검증
- `발급_토큰_출력_테스트`: 정상적으로 토큰이 발급되었는지 확인
- `토큰_유효성_검사_테스트`: 받은 공개키로 실제 토큰의 유효성 검증

<br/>

### ③ 구조적 장점

- 이 통합 테스트는 실제 인증 서버가 실행 중인 상태에서 테스트되므로,  
  네트워크 통신, 키 파싱, 검증까지 **전체 흐름을 보장**합니다.
- `InterServerTestProperties`만 변경하면 **다른 확장 서버에서도 그대로 사용** 가능하며,  
  `interserverauth` 모듈의 검증에도 그대로 재활용할 수 있습니다.

<br/>
<br/>

## 결과

| 항목        | 내용                                                                            |
| ----------- | ------------------------------------------------------------------------------- |
| 검증 범위   | 인증 서버와의 연동, 키 로딩, JWT 발급 및 검증 전 과정                           |
| 재사용성    | 테스트 구성 요소를 별도 모듈로 분리하여, 다른 확장 서버에서도 사용 가능         |
| 신뢰성      | 실제 서비스 흐름을 그대로 반영하여 테스트의 신뢰도 확보                         |
| 유지보수성  | 클라이언트 정보, JWT URL 등 설정만 교체하면 동일한 구조로 모든 서버에 적용 가능 |
| 회귀 테스트 | JWT 구조 변경, 키 처리 방식 변경 시에도 회귀 테스트로 활용 가능                 |

> 참고 클래스: `InterServerAuthTest`, `InterServerKeyTokenTestProvider`, `InterServerJwtVerifier`
